## é…ç½®é€‰é¡¹

`natty-fetch`ä¸­ã€ä»»ä½•ã€‘å±‚çº§çš„é…ç½®éƒ½å¯ä»¥ä¼ å…¥ä»¥ä¸‹å‚æ•°ã€‚

### Outline

Base optionsï¼š

* [data](#data)
* [header](#header)
* [jsonp](#jsonp)
* [method](#method)
* [mock](#mock)
* [mockUrl](#mockurl)
* [mockUrlPrefix](#mockurlprefix)
* [timeout](#timeout)
* [traditional](#traditional)
* [url](#url)
* [urlPrefix](#urlprefix)
* [urlStamp](#urlstamp)
* [withCredentials](#withcredentials)

Hook optionsï¼š

* [fit](#fit)
* [process](#process)
* [willFetch](#willFetch)
* [didFetch](#didFetch)

Powerful optionsï¼š

* [ignoreSelfConcurrent](#ignoreSelfConcurrent)
* [overrideSelfConcurrent](#overrideSelfConcurrent)
* [plugins](#plugins)
* [storage](#storage)
* [retry](#retry)


### data

è¯·æ±‚çš„å›ºå®šå‚æ•°ã€‚åœ¨å…¨å±€é…ç½®æˆ–ä¸Šä¸‹æ–‡é…ç½®ä¸­é€šå¸¸ä¼šè®¾ç½®å’Œåç«¯çº¦å®šçš„å‚æ•°ï¼Œæ¯”å¦‚`token`ã€‚åœ¨æ¥å£é…ç½®ä¸­ï¼Œ`data`å‚æ•°ç”¨äºå®šä¹‰è¯¥æ¥å£çš„å›ºå®šå‚æ•°ã€‚

* ç±»å‹ï¼šObject | Function
* é»˜è®¤ï¼š{}

##### ç¤ºä¾‹ï¼šå›ºå®šå‚æ•° ä¸ åŠ¨æ€å‚æ•°

å‡è®¾æœ‰ä¸€ä¸ªæ¥å£ï¼Œç”¨äºè·å–é™„è¿‘çš„å‡ºç§Ÿè½¦æ•°é‡ï¼Œè¿™ä¸ªæ¥å£æ¥å—ä¸‰å‚æ•°ï¼Œä¸€ä¸ªæ˜¯æŸ¥è¯¢åŠå¾„ï¼Œå¦ä¸¤ä¸ªæ˜¯åœ°ç†åæ ‡çš„ç»çº¬åº¦ï¼Œå¾ˆæ˜¾ç„¶ï¼Œå¯ä»¥æŠŠæŸ¥è¯¢åŠå¾„å®šä¹‰ä¸ºå›ºå®šå‚æ•°ï¼Œè¿™æ ·åœ¨è°ƒç”¨æ¥å£çš„æ—¶å€™å°±ä¸éœ€è¦åå¤ä¼ å…¥äº†ã€‚

åœ¨å®šä¹‰æ¥å£æ—¶å£°æ˜å›ºå®šå‚æ•°ï¼Œç¡®å®šæŸ¥è¯¢åŠå¾„ä¸º3å…¬é‡Œã€‚

```js
context.create({
    'taxi.getNumber': {
        url: 'driver/getNearDrivers'
        data: {
            radius: 3 // å›ºå®šå‚æ•°ï¼ŒæŒ‡å®šæŸ¥è¯¢åŠå¾„ä¸º3å…¬é‡Œ
        }
    }
});
```

åœ¨è°ƒç”¨æ¥å£æ—¶ä¼ å…¥åŠ¨æ€å‚æ•°ï¼Œä»¥æ‰€åœ¨çš„ç»çº¬åº¦ä¸ºåœ†å¿ƒï¼ŒæŸ¥ç¾¤3å…¬é‡ŒèŒƒå›´å†…çš„å‡ºç§Ÿè½¦æ•°é‡ã€‚

```js
db.taxi.getNumber({
    longitude: 120.0190524487949, // åŠ¨æ€å‚æ•°ï¼šç»åº¦
    latitude:  30.28173475473827, // åŠ¨æ€å‚æ•°ï¼šçº¬åº¦
}).then(function(content){...}).catch(function(error){...});
```

> ğŸ» å°½å¯èƒ½çš„å°†å›ºå®šå‚æ•°å£°æ˜åœ¨æ¥å£å®šä¹‰çš„æ¨¡å—ä¸­ï¼Œè®©è°ƒç”¨æ¥å£çš„ä¸šåŠ¡ä»£ç æ›´æ¸…çˆ½ã€‚

### didFetch

è¯·æ±‚æ‰§è¡Œå®Œæˆåçš„å›è°ƒå‡½æ•°ã€‚æ¥å—ä¸¤ä¸ªå‚æ•°`vars`å’Œ`config`ã€‚

* ç±»å‹ï¼šFunction
* é»˜è®¤ï¼š`function(){}`

### fit

æ•°æ®ç»“æ„é¢„å¤„ç†å‡½æ•°ï¼Œæ¥æ”¶å®Œæ•´çš„å“åº”æ•°æ®ä½œä¸ºå‚æ•°ï¼Œåªç”¨äºè§£å†³æ•°æ®ç»“æ„ä¸ä¸€è‡´çš„é—®é¢˜ã€‚

* ç±»å‹ï¼šFunction
* é»˜è®¤ï¼šfunction (response) { return response }

`natty-fetch`æ¥å—çš„æ ‡å‡†æ•°æ®ç»“æ„æ˜¯

```js
// æ­£ç¡®
{
    success: true,
    content: {}
}
// é”™è¯¯
{
    success: false,
    error: {}
}
```

##### ç¤ºä¾‹

å‡è®¾å®é™…é¡¹ç›®ä¸­ï¼Œæ¥å£è¯·æ±‚è¿”å›çš„æ•°æ®ç»“æ„æ˜¯

```js
{
    hasError: false, // or true
    content: {},
    error: 'some message'
}
```

è¿™æ—¶å€™éœ€è¦ç”¨`fit`æ¥é€‚é…ï¼Œè½¬æ¢æˆ`natty-fetch`çº¦å®šçš„æ•°æ®ç»“æ„è¿”å›ã€‚

```js
fit: function (response) {
    let ret = {
        success: !response.hasError
    };
    
    if (ret.success) {
        ret.content = response.content;
    } else {
        ret.error = {
            message: response.error;
        }
    }
    return ret;
}
```

### header

è‡ªå®šä¹‰`ajax`è¯·æ±‚çš„å¤´éƒ¨ä¿¡æ¯ã€‚å½“`ajax`è¯·æ±‚è·¨åŸŸæ—¶ï¼Œè¯¥é…ç½®å°†è¢«å¿½ç•¥ã€‚

* ç±»å‹ï¼šObject
* é»˜è®¤ï¼š{}
* æ³¨æ„ï¼šåªé’ˆå¯¹éè·¨åŸŸçš„`ajax`è¯·æ±‚æœ‰æ•ˆ

### ignoreSelfConcurrent

æ˜¯å¦å¿½ç•¥æ¥å£è‡ªèº«çš„å¹¶å‘è¯·æ±‚ï¼Œå³æ˜¯å¦å¼€å¯è¯·æ±‚é”ã€‚

* ç±»å‹ï¼šBoolean
* é»˜è®¤ï¼šfalse

##### ç¤ºä¾‹

å‡è®¾æœ‰ä¸€ä¸ªåˆ›å»ºè®¢å•çš„æŒ‰é’®ï¼Œç‚¹å‡»å³å‘èµ·è¯·æ±‚ï¼Œæœ€ç†æƒ³çš„æƒ…å†µï¼Œè¿™ä¸ª"åˆ›å»ºè®¢å•"çš„è¯·æ±‚å¿…å®šè¦åšå®¢æˆ·ç«¯çš„è¯·æ±‚é”ï¼Œæ¥é¿å…ç›¸åŒçš„ä¿¡æ¯è¢«æ„å¤–åœ°åˆ›å»ºäº†å¤šä»½è®¢å•ã€‚åœ¨natty-fetchä¸­ï¼Œåªéœ€è¦ä¸€ä¸ªå‚æ•°å³å¯å¼€å¯è¯·æ±‚é”ã€‚

```js
DBContext.create('Order', {
    create: {
        url: 'api/createOrder',
        // å¼€å¯è¯·æ±‚é”
        // è¯¥æ¥å£åœ¨æœåŠ¡ç«¯è¿”å›å“åº”ä¹‹å‰ï¼Œå¦‚æœå†æ¬¡è¢«è°ƒç”¨ï¼Œå°†è¢«å¿½ç•¥ã€‚
        ignoreSelfConcurrent: true
    }
});
```

### jsonp

è¯·æ±‚æ–¹å¼æ˜¯å¦ä½¿ç”¨`jsonp`ï¼Œå½“å€¼ä¸º`true`æ—¶ï¼Œé»˜è®¤çš„urlå‚æ•°å½¢å¦‚`?callback=jsonp3879494623`ï¼Œå¦‚æœéœ€è¦è‡ªå®šä¹‰`jsonp`çš„`url`å‚æ•°ï¼Œå¯ä»¥é€šè¿‡æ•°ç»„å‚æ•°é…ç½®ã€‚

* ç±»å‹ï¼šBoolean | Array
* é»˜è®¤ï¼šfalse
* ç¤ºä¾‹ï¼š[true, 'cb', 'j{id}']

### method

é…ç½®ajaxçš„è¯·æ±‚æ–¹å¼ã€‚

* ç±»å‹ï¼šString
* é»˜è®¤ï¼š'GET'
* å¯é€‰ï¼š'GET'ã€'POST'

> å¦‚æœæµè§ˆå™¨æ˜¯`IE8/9`ï¼Œåˆ™`natty-fetch`å†…éƒ¨ä½¿ç”¨çš„æ˜¯`XDomainRequest`å¯¹è±¡ï¼Œä»¥ä¾¿æ”¯æŒè·¨åŸŸåŠŸèƒ½ï¼Œä½†`XDomainRequest`å¯¹è±¡ä»…æ”¯æŒ`GET`å’Œ`POST`ä¸¤ä¸ªæ–¹æ³•ã€‚

### mock

æ˜¯å¦å¼€å¯mockæ¨¡å¼

* ç±»å‹ï¼šBoolean
* é»˜è®¤ï¼šfalse

### mockUrl

mockæ¨¡å¼å¼€å¯æ—¶çš„è¯·æ±‚åœ°å€

* ç±»å‹ï¼šString
* é»˜è®¤ï¼š''(ç©ºå­—ç¬¦ä¸²)

### mockUrlPrefix

mockæ¨¡å¼å¼€å¯æ—¶çš„è¯·æ±‚åœ°å€å‰ç¼€ï¼Œå¦‚æœmockUrlçš„å€¼æ˜¯"ç»å¯¹è·¯å¾„"æˆ–"ç›¸å¯¹è·¯å¾„"ï¼Œåˆ™ä¸ä¼šè‡ªåŠ¨æ·»åŠ è¯¥å‰ç¼€ã€‚

* ç±»å‹ï¼šString
* é»˜è®¤ï¼š''(ç©ºå­—ç¬¦ä¸²)

### overrideSelfConcurrent

æ˜¯å¦å–æ¶ˆä¸Šä¸€æ¬¡æ²¡æœ‰å®Œæˆçš„è¯·æ±‚ã€‚å³ï¼šåœ¨å½“ä¸Šä¸€æ¬¡è¯·æ±‚ç»“æŸä¹‹å‰ï¼Œå¦‚æœåˆå‘èµ·äº†ä¸‹ä¸€æ¬¡è¯·æ±‚ï¼Œåˆ™åªæ‰§è¡Œåä¸€æ¬¡è¯·æ±‚çš„å“åº”ã€‚æ›´å¤šæ¬¡æ•°ä»¥æ­¤ç±»æ¨ã€‚

* ç±»å‹ï¼šBoolean
* é»˜è®¤ï¼šfalse

##### ç¤ºä¾‹

å‡è®¾æœ‰ä¸€ä¸ªè‡ªåŠ¨è¡¥å…¨è¾“å…¥æ¡†ï¼Œå½“æ¯æ¬¡æœ‰æ–°çš„å­—ç¬¦è¾“å…¥æ—¶ï¼Œéƒ½ä¼šå‘æœåŠ¡ç«¯å‘èµ·æ–°è¯·æ±‚ï¼Œå–å¾—åŒ¹é…çš„å¤‡é€‰åˆ—è¡¨ï¼Œå½“è¾“å…¥é€Ÿåº¦å¾ˆå¿«æ—¶ï¼ŒæœŸæœ›çš„æ˜¯åªæ‰§è¡Œæœ€åä¸€æ¬¡è¯·æ±‚çš„å“åº”ï¼Œå› ä¸ºæœ€åä¸€æ¬¡çš„å­—ç¬¦æœ€å…¨ï¼ŒåŒ¹é…çš„åˆ—è¡¨æ›´ç²¾å‡†ã€‚è¿™ç§ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œå¯ä»¥é€šè¿‡é…ç½®`overrideSelfConcurrent`ä¸º`true`ï¼Œä¸€æ˜¯å¯ä»¥èŠ‚çœå“åº”æ¬¡æ•°ã€‚äºŒæ¬¡èƒ½é¿å…å…ˆå‘å‡ºçš„è¯·æ±‚å´æœ€åå“åº”(å¹¶å‘å¼‚æ­¥è¯·æ±‚çš„å“åº”é¡ºåºä¸ä¸€å®šå’Œè¯·æ±‚é¡ºåºä¸€è‡´)ï¼Œå¯¼è‡´æ¨èçš„æ•°æ®åˆ—è¡¨ä¸å‡†ç¡®ã€‚

```js
DBContext.create('City', {
    getSuggestion: {
        url: 'api/getCitySuggestion',
        // å¼€å¯è¦†ç›–å“åº”
        overrideSelfConcurrent: true
    }
});

// å¹¶å‘
DB.City.getSuggestion({key:'a'}).then(...); // ä¸å“åº”
DB.City.getSuggestion({key:'ab'}).then(...); // å“åº”
```

### process

è¯·æ±‚æˆåŠŸæ—¶çš„æ•°æ®å¤„ç†å‡½æ•°ï¼Œè¯¥å‡½æ•°æ¥æ”¶åˆ°çš„å‚æ•°æ˜¯ä¸‹æ–‡çš„"æ•°æ®ç»“æ„çº¦å®š"ä¸­`content`çš„å€¼ã€‚

* ç±»å‹ï¼šFunction
* é»˜è®¤ï¼šfunction (content) {return content}

### retry

åœ¨è¯·æ±‚å¤±è´¥(ç½‘ç»œé”™è¯¯ï¼Œè¶…æ—¶ï¼Œsuccessä¸ºfalseç­‰)æ—¶æ˜¯å¦è¿›è¡Œè¯·æ±‚é‡è¯•ã€‚

* ç±»å‹ï¼šNumber
* é»˜è®¤ï¼š0

### timeout

è¶…æ—¶æ—¶é—´ï¼Œ0è¡¨ç¤ºä¸å¯åŠ¨è¶…æ—¶å¤„ç†ã€‚

* ç±»å‹ï¼šNumber
* é»˜è®¤ï¼š0

### traditional

å’Œ`jQuery/Zepto`çš„`param`æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ä¸€æ ·çš„æ•ˆæœã€‚

* ç±»å‹ï¼šBoolean
* é»˜è®¤ï¼šfalse

### url

* ç±»å‹ï¼šString
* é»˜è®¤ï¼š''(ç©ºå­—ç¬¦ä¸²)

è¯·æ±‚åœ°å€

### urlPrefix

è¯·æ±‚åœ°å€å‰ç¼€ï¼Œå¦‚æœurlçš„å€¼æ˜¯"ç»å¯¹è·¯å¾„"æˆ–"ç›¸å¯¹è·¯å¾„"ï¼Œåˆ™ä¸ä¼šè‡ªåŠ¨æ·»åŠ è¯¥å‰ç¼€ã€‚

* ç±»å‹ï¼šString
* é»˜è®¤ï¼š''(ç©ºå­—ç¬¦ä¸²)

### urlStamp

æ˜¯å¦åœ¨`url`çš„`search`ä¸­åŠ å…¥æ—¶é—´æˆ³(`__stamp`)å‚æ•°ï¼Œå±è”½æµè§ˆå™¨é»˜è®¤çš„ç¼“å­˜(304)æœºåˆ¶ã€‚

* ç±»å‹ï¼šBoolean
* é»˜è®¤ï¼štrue

### willFetch

è¯·æ±‚æ‰§è¡Œå‰çš„å›è°ƒå‡½æ•°ã€‚ã€‚æ¥å—ä¸¤ä¸ªå‚æ•°`vars`å’Œ`config`ã€‚

* ç±»å‹ï¼šFunction
* é»˜è®¤ï¼š`function(){}`

### withCredentials

æ˜¯å¦å‘é€`cookie`ï¼Œ`natty-fetch`å†…éƒ¨å·²ç»é€šè¿‡åˆ¤æ–­`url`æ˜¯å¦è·¨åŸŸæ¥è‡ªåŠ¨è®¾ç½®è¯¥å€¼ï¼Œæ‰€ä»¥ä¸å»ºè®®æ‰‹åŠ¨è®¾ç½®ã€‚

* ç±»å‹ï¼šBoolean
* é»˜è®¤ï¼šé€šè¿‡åˆ¤æ–­`url`æ˜¯å¦è·¨åŸŸæ¥è‡ªåŠ¨è®¾ç½®è¯¥å€¼ï¼Œè·¨åŸŸæ—¶ä¸º`false`

### plugins

é…ç½®å¯ç”¨çš„æ’ä»¶ã€‚

* ç±»å‹ï¼šArray
* é»˜è®¤ï¼š[]
* å¯ç”¨å€¼ï¼š
  - natty-fetch.plugin.soon
  - natty-fetch.plugin.loop

##### `soon`

åœ¨`storage`å¼€å¯çš„æƒ…å†µä¸‹ï¼Œä¼šé©¬ä¸Šä½¿ç”¨`storage`ç¼“å­˜çš„æ•°æ®æ‰§è¡Œå›è°ƒï¼Œå¹¶åŒæ—¶å‘èµ·è¿œç¨‹è¯·æ±‚ï¼Œå¹¶å°†è¯·æ±‚å›æ¥çš„æ–°æ•°æ®åŒæ­¥åˆ°`storage`ä¸­ï¼Œå†ç¬¬äºŒæ¬¡æ‰§è¡Œå›è°ƒã€‚

```js
let Order = DBContext.create('Order', {
    getList: {
        url: '...',
        storage: true,
        plugins: [
            natty-fetch.plugin.soon
        ]
    }
});

Order.getList.soon({}, function(data){
    // `data`çš„ç»“æ„å¦‚ä¸‹
    // {
    //     fromStorage: true, 
    //     content: {}
    // }
    //
    // å¦‚æœæ˜¯é¦–æ¬¡è¯·æ±‚ï¼Œè¯¥å›è°ƒåªä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œ
    // `data.fromStorage`ä¸º`false`ï¼Œ`data.content`æ¥è‡ªè¿œç¨‹æ¥å£ã€‚
    //
    // å¦‚æœæ˜¯éé¦–æ¬¡è¯·æ±‚ï¼Œè¯¥å›è°ƒä¼šæ‰§è¡Œä¸¤æ¬¡ï¼Œ
    // ç¬¬ä¸€æ¬¡çš„`data.fromStorage`ä¸º`true`ï¼Œ`data.content`æ¥è‡ªç¼“å­˜ï¼Œæ‰€ä»¥ä¼šå¾ˆå¿«ã€‚
    // ç¬¬äºŒæ¬¡çš„`data.fromStorage`ä¸º`false`ï¼Œ`data.content`æ¥è‡ªè¿œç¨‹æ¥å£ã€‚
}, function(error){
    // ä»»ä½•å¼‚å¸¸
})
```

##### `loop`

åˆ›å»ºè½®è¯¢è¯·æ±‚ä»æ¥å°±æ²¡æœ‰è¿™ä¹ˆç®€å•è¿‡ï¼

```js
context.create('driver', {
    getDistance: {
        url: '...',
        plugins: [
            natty-fetch.plugin.loop
        ]
    }
});

// å¼€å§‹è½®è¯¢
let stopHandler = db.driver.getDistance.loop({
  // è½®è¯¢ä½¿ç”¨çš„å‚æ•°
  data: {...},
  // é—´éš”æ—¶é—´
  duration: 5000
}, function (content) {
  // æˆåŠŸå›è°ƒ
}, function (error) {
  // å¤±è´¥å›è°ƒ
});

// ç»“æŸè½®è¯¢
stopHandler();

// è½®è¯¢çŠ¶æ€
stopHandler.looping; // true or false
```

### storage

æ˜¯å¦å¼€å¯ç¼“å­˜åŠŸèƒ½ã€‚è¯¥åŠŸèƒ½ä»…å­˜åœ¨äº`v2.0.0`ä»¥ä¸Šçš„ç‰ˆæœ¬

* ç±»å‹ï¼šfalse | Object
* é»˜è®¤ï¼šfalse

`natty-fetch`çš„ç¼“å­˜åŠŸèƒ½ç”±`natty-storage`æä¾›ï¼Œ`storage`é…ç½®å¦‚æœæ˜¯å¯¹è±¡å€¼ï¼Œå¯å‚è€ƒ`natty-storage`çš„æ–‡æ¡£ã€‚æ³¨æ„`key`æ˜¯å¿…é¡»é…ç½®çš„é€‰é¡¹ï¼
